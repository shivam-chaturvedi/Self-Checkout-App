<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS for smooth alert animation */
        .fade {
            transition: opacity 0.5s ease;
            opacity: 0;
        }

        .fade.show {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-200 min-h-screen p-5">
    <div id="on-delete-alert-success" class="fade hidden p-4 mb-4 text-sm text-center text-green-800 rounded-lg bg-green-50" role="alert">
        <span class="font-medium"> Product Deleted Successfully! </span>
    </div>

    <!-- Main Container -->
    <div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-4xl mx-auto">

        <!-- Button for adding a product -->
        <div class="flex justify-end mb-4">
            <button id="add-product"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                + Add Product
            </button>
        </div>

        <h1 class="text-2xl font-semibold text-gray-800 mb-6">Products</h1>

        <!-- Add Product Form Section (centered and with drop shadow) -->
        <div id="addProductForm" class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
            <div class="max-w-lg w-full p-6 bg-white shadow-2xl rounded-lg relative">
                <h2 class="text-xl font-semibold mb-6 text-center">Add Your Products Here</h2>

                <!-- Form for adding products -->
                <form method="post" action="product/add" class="space-y-4">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="text" name="name" placeholder="Enter Product Name..." required
                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <input type="number" name="price" placeholder="Enter Price (in ₹)" required min="1" step="any"
                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded transition">
                        Add Product
                    </button>
                </form>

                <!-- Cancel button to close the form -->
                <button id="cancelButton" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0 0 50 50">
                        <path d="M25 2C12.3 2 2 12.3 2 25s10.3 23 23 23 23-10.3 23-23S37.7 2 25 2zm7.99 13.99a1 1 0 00-1.41 0L25 23.58l-6.29-6.3a1 1 0 00-1.41 1.41L23.58 25l-6.3 6.29a1 1 0 101.41 1.41L25 26.42l6.29 6.3a1 1 0 001.41-1.41L26.42 25l6.3-6.29a1 1 0 00-.03-1.42z"></path>
                    </svg>
                </button>

                <!-- Bulk Upload Form -->
                <div class="mt-8 text-center">
                    <p class="font-semibold mb-2">Or Bulk Upload Products</p>
                    <form method="post" action="product/upload" enctype="multipart/form-data" class="space-y-4">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="file" name="products" accept=".csv" required
                            class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded transition">
                            Upload CSV
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="overflow-x-auto mt-8">
            <table class="min-w-full bg-white border border-gray-200 text-left text-sm">
                <thead class="bg-gray-100 text-gray-600 font-semibold uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3 border-b border-gray-200">Created At</th>
                        <th class="px-4 py-3 border-b border-gray-200">Updated At</th>
                        <th class="px-4 py-3 border-b border-gray-200">ID</th>
                        <th class="px-4 py-3 border-b border-gray-200">Name</th>
                        <th class="px-4 py-3 border-b border-gray-200">Price</th>
                        <th class="px-4 py-3 border-b border-gray-200">QR Code</th>
                        <th class="px-4 py-3 border-b border-gray-200">Remove</th>
                    </tr>
                </thead>
                <tbody id="table" class="text-gray-700">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const table = document.getElementById("table");
        const productForm = document.getElementById("addProductForm");
        const addProductButton = document.getElementById("add-product");
        const cancelButton = document.getElementById("cancelButton");
        const onDeleteAlertSuccess = document.getElementById("on-delete-alert-success");

        // Show the add product form
        addProductButton.addEventListener('click', () => {
            productForm.classList.remove('hidden');
        });

        // Hide the add product form
        cancelButton.addEventListener('click', () => {
            productForm.classList.add('hidden');
        });

        // Fetch and display products on page load
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const res = await fetch('/product/get-all');
                const data = await res.json();

                if (res.ok) {
                    data.forEach((product) => {
                        const row = table.insertRow();
                        row.insertCell(0).textContent = product.createdAt;
                        row.insertCell(1).textContent = product.updatedAt;
                        row.insertCell(2).textContent = product.id;
                        row.insertCell(3).textContent = product.name;
                        row.insertCell(4).textContent = `₹${product.price}`;

                        // QR Code cell with download link
                        const qrCell = row.insertCell(5);
                        qrCell.className = "px-4 py-2";
                        qrCell.innerHTML = `
                            <a href="/admin/product/qr/${product.id}" class="text-blue-500 hover:text-blue-700" target="_blank">
                                <svg class="w-6 h-6 inline-block" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M4 4h4v4H4V4zm6 0h4v4h-4V4zm0 6h4v4h-4v-4zM4 10h4v4H4v-4zm6 6h4v4h-4v-4zM4 16h4v-4H4v-4zm10-6h6v6h-2v-4h-4v-2zm6-6v4h-2V4h-4V2h6v2zm-6 6v2h-2v-2h2z"/>
                                </svg> QR Code
                            </a>`;

                        // Remove cell with delete button
                        const deleteCell = row.insertCell(6);
                        deleteCell.className = "px-4 py-2";
                        deleteCell.innerHTML = `
                            <button class="text-red-500 hover:text-red-700" onclick="deleteProduct(${product.id}, this)">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 6l3 18h12l3-18H3zm3 0h12l-2-4H8l-2 4zm2 4h6v12H8V10z"/>
                                </svg>
                            </button>`;
                    });
                } else {
                    console.error('Failed to load products:', data);
                }
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        });

        // Delete product function
        async function deleteProduct(id, button) {
            if (confirm("Are you sure you want to delete this product?")) {
                const res = await fetch(`/product/delete/${id}`, { method: 'DELETE' });
                const data = await res.json();

                if (res.ok) {
                    const row = button.closest('tr');
                    row.remove();

                    // Show success alert
                    onDeleteAlertSuccess.classList.remove('hidden');
                    onDeleteAlertSuccess.classList.add('show');

                    // Hide alert after 3 seconds
                    setTimeout(() => {
                        onDeleteAlertSuccess.classList.remove('show');
                        onDeleteAlertSuccess.classList.add('hidden');
                    }, 3000);
                } else {
                    console.error('Failed to delete product:', data);
                }
            }
        }
    </script>
</body>
</html>
