<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-custom-green {
            background-color: #4CAF50;
        }

        .bg-custom-red {
            background-color: #FF4B4B;
        }

        /* Smooth animation */
        .fade {
            transition: opacity 0.5s ease;
            opacity: 0;
        }

        .fade.show {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-200 min-h-screen p-5">

    <!-- Navbar -->
    <div class="bg-custom-green text-white p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Self Checkout</h1>

        <!-- Navbar Toggle for Mobile -->
        <button id="menuToggle" class="md:hidden text-white focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
            </svg>
        </button>

        <!-- Navbar Links -->
        <nav id="navbar" class="hidden md:flex space-x-4 items-center">
            <a href="/admin" class="bg-green-800 hover:bg-green-600 text-white py-2 px-4 rounded transition">Admin</a>
            <a href="/" class="bg-green-800 hover:bg-green-600 text-white py-2 px-4 rounded transition">Home</a>
            <a href="/logout" class="bg-custom-red hover:bg-red-600 text-white py-2 px-4 rounded transition">Logout</a>
        </nav>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="md:hidden bg-custom-green text-white space-y-2 p-4 hidden">
        <a href="/admin" class="block bg-green-800 hover:bg-green-600 text-white py-2 px-4 rounded transition w-full text-center">Admin</a>
        <a href="/" class="block bg-green-800 hover:bg-green-600 text-white py-2 px-4 rounded transition w-full text-center">Home</a>
        <a href="/logout" class="block bg-custom-red hover:bg-red-600 text-white py-2 px-4 rounded transition w-full text-center">Logout</a>
    </div>

    <!-- Success Alert -->
    <div id="on-delete-alert-success" class="fade hidden p-4 mb-4 text-sm text-center text-green-800 rounded-lg bg-green-50" role="alert">
        <span class="font-medium"> Product Deleted Successfully! </span>
    </div>

    <!-- Main Container -->
    <div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-4xl mx-auto mt-5">
        <div class="flex justify-end mb-4">
            <button id="add-product" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">+ Add Product</button>
        </div>

        <h1 class="text-2xl font-semibold text-gray-800 mb-6">Products</h1>

        <!-- Products Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 text-left text-sm">
                <thead class="bg-gray-100 text-gray-600 font-semibold uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3 border-b border-gray-200">Created At</th>
                        <th class="px-4 py-3 border-b border-gray-200">Updated At</th>
                        <th class="px-4 py-3 border-b border-gray-200">ID</th>
                        <th class="px-4 py-3 border-b border-gray-200">Name</th>
                        <th class="px-4 py-3 border-b border-gray-200">Price</th>
                        <th class="px-4 py-3 border-b border-gray-200">QR Code</th>
                        <th class="px-4 py-3 border-b border-gray-200">Edit</th>
                        <th class="px-4 py-3 border-b border-gray-200">Remove</th>
                    </tr>
                </thead>
                <tbody id="table" class="text-gray-700">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Product Form -->
    <div id="addProductForm" class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
        <div class="max-w-lg w-full p-6 bg-white shadow-2xl rounded-lg relative">
            <h2 class="text-xl font-semibold mb-6 text-center">Add or Edit Product</h2>
            <form id="productForm" method="post" class="space-y-4">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" id="productId" name="productId" />
                <input type="text" name="name" id="productName" placeholder="Enter Product Name..." required class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" />
                <input type="number" name="price" id="productPrice" placeholder="Enter Price (in ₹)" required min="1" step="any" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" />
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded transition">Save Product</button>
            </form>
            <button id="cancelButton" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">✖</button>
        </div>
    </div>

    <script>
        const table = document.getElementById("table");
        const productForm = document.getElementById("addProductForm");
        const addProductButton = document.getElementById("add-product");
        const cancelButton = document.getElementById("cancelButton");
        const onDeleteAlertSuccess = document.getElementById("on-delete-alert-success");
        const productIdField = document.getElementById("productId");
        const productNameField = document.getElementById("productName");
        const productPriceField = document.getElementById("productPrice");

        // Show the add product form
        addProductButton.addEventListener('click', () => {
            productForm.classList.remove('hidden');
        });

        // Hide the add product form
        cancelButton.addEventListener('click', () => {
            productForm.classList.add('hidden');
        });

        // Toggle Mobile Menu
        document.getElementById("menuToggle").addEventListener("click", () => {
            document.getElementById("mobileMenu").classList.toggle("hidden");
        });

        // Fetch and display products on page load
        document.addEventListener("DOMContentLoaded", async () => {
            await loadProducts();
        });

        // Function to load products
        async function loadProducts() {
            try {
                const res = await fetch('/product/get-all');
                const data = await res.json();

                table.innerHTML = ''; // Clear current table
                if (res.ok) {
                    data.forEach((product) => {
                        addProductRow(product);
                    });
                } else {
                    console.error('Failed to load products:', data);
                }
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        }

        // Function to add product row to table
        function addProductRow(product) {
            const row = table.insertRow();
            row.id = `product-row-${product.id}`;
            row.insertCell(0).textContent = product.createdAt;
            row.insertCell(1).textContent = product.updatedAt;
            row.insertCell(2).textContent = product.id;
            row.insertCell(3).textContent = product.name;
            row.insertCell(4).textContent = `₹${product.price}`;

            // QR Code cell with download link
            const qrCell = row.insertCell(5);
            qrCell.className = "px-4 py-2";
            qrCell.innerHTML = `<a href="/admin/product/qr/${product.id}" class="text-blue-500 hover:text-blue-700" target="_blank">QR Code</a>`;

            // Edit cell with edit button
            const editCell = row.insertCell(6);
            editCell.className = "px-4 py-2";
            editCell.innerHTML = `<button onclick="editProduct(${product.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded">Edit</button>`;

            // Remove cell with delete button
            const deleteCell = row.insertCell(7);
            deleteCell.className = "px-4 py-2";
            deleteCell.innerHTML = `<button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">Remove</button>`;
        }

        // Function to edit a product
        function editProduct(id) {
            const row = document.getElementById(`product-row-${id}`);
            const name = row.cells[3].textContent;
            const price = row.cells[4].textContent.replace('₹', '');

            productIdField.value = id;
            productNameField.value = name;
            productPriceField.value = price;

            productForm.classList.remove('hidden');
        }

        // Submit the product form (Add or Edit)
        document.getElementById("productForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = productIdField.value;
            const name = productNameField.value;
            const price = parseFloat(productPriceField.value);

            try {
                const response = await fetch('/product/save', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, name, price })
                });

                if (response.ok) {
                    await loadProducts();
                    productForm.classList.add('hidden');
                    alert(id ? 'Product updated successfully' : 'Product added successfully');
                } else {
                    alert('Failed to save product');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Delete product
        async function deleteProduct(id) {
            const row = document.getElementById(`product-row-${id}`);
            try {
                const response = await fetch(`/product/remove/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    row.remove();
                    showSuccessMessage();
                } else {
                    alert('Failed to delete product');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }

        // Show success alert
        function showSuccessMessage() {
            onDeleteAlertSuccess.classList.add('show');
            setTimeout(() => {
                onDeleteAlertSuccess.classList.remove('show');
            }, 3000);
        }
    </script>
</body>

</html>
